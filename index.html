<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>מחשבון מנגנון הרמה</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            --primary: #2196F3;
            --accent: #FFC107;
            --load-color: #E91E63;
            --dark: #333;
            --light: #f5f5f5;
            --panel: #ffffff;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; padding: 0;
            background: var(--light);
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
            text-align: right;
        }

        /* אזור הסימולציה */
        #canvas-container {
            position: relative; width: 100%; height: 45vh;
            background: #eef2f5; border-bottom: 2px solid #ddd;
            overflow: hidden; touch-action: none;
            direction: ltr; /* הקנבס נשאר LTR לחישובים קואורדינטות */
        }
        canvas { display: block; width: 100%; height: 100%; }
        .zoom-hint {
            position: absolute; top: 10px; left: 10px; /* צד שמאל כי זה RTL */
            background: rgba(255,255,255,0.8); padding: 5px 10px;
            border-radius: 15px; font-size: 0.75rem; color: #666; pointer-events: none;
        }

        /* פס שליטה */
        .control-strip {
            background: #fff; padding: 15px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; flex-shrink: 0;
        }
        .slider-label {
            display: flex; justify-content: space-between;
            font-weight: bold; margin-bottom: 5px; color: var(--dark);
        }
        input[type=range] { width: 100%; height: 30px; direction: ltr; }

        /* אזור גלילה */
        .scroll-content {
            flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px;
            background: #fff;
        }
        .tabs {
            display: flex; margin-bottom: 20px; background: #eee;
            border-radius: 8px; padding: 4px;
        }
        .tab {
            flex: 1; text-align: center; padding: 10px; border-radius: 6px;
            font-weight: 500; cursor: pointer; transition: background 0.2s;
        }
        .tab.active { background: #fff; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* קלטים */
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .input-group label {
            display: block; font-size: 0.85rem; color: #666; margin-bottom: 5px;
        }
        .input-group input {
            width: 100%; padding: 10px; font-size: 1rem;
            border: 1px solid #ccc; border-radius: 6px; background: #f9f9f9;
            text-align: left; direction: ltr; /* מספרים באנגלית */
        }

        /* תצוגת מתמטיקה */
        .math-block {
            background: #fff; border: 1px solid #eee; padding: 10px;
            border-radius: 8px; overflow-x: auto; font-size: 0.9rem; margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            direction: ltr; text-align: left; /* מתמטיקה משמאל לימין */
        }
        .math-text-he {
            direction: rtl; text-align: right; margin-bottom: 5px; color: #444; font-weight: bold;
        }
        
        .section { display: none; }
        .section.active { display: block; }
        
        #mj-loading { font-size: 0.8rem; color: #999; text-align: center; margin-top: 5px; opacity: 0; transition: opacity 0.3s; }
        #mj-loading.show { opacity: 1; }
    </style>
</head>
<body>

<div id="canvas-container">
    <div class="zoom-hint">צבוט לזום • גרור להזזה</div>
    <canvas id="simCanvas"></canvas>
</div>

<div class="control-strip">
    <div class="slider-label">
        <span id="angleDisplay">0°</span>
        <span>פתיחת בוכנה</span>
    </div>
    <input type="range" id="liftSlider" min="0" max="100" value="20">
</div>

<div class="scroll-content">
    <div class="tabs">
        <div class="tab active" onclick="switchTab('inputs', event)">נתונים</div>
        <div class="tab" onclick="switchTab('calcs', event)">חישובים</div>
    </div>

    <div id="tab-inputs" class="section active">
        <h3 style="margin-top:0">מידות (ס"מ) ועומס</h3>
        <p style="font-size:0.8rem; color:#666;">הסימולציה מתעדכנת בזמן אמת</p>
        
        <div class="input-grid">
            <div class="input-group"><label>עומס משקל (ק"ג)</label><input type="number" id="inp_Load" value="6000"></div>
            <div class="input-group"><label>קוטר בוכנה (ס"מ)</label><input type="number" id="inp_Diam" value="10"></div>
            
            <div class="input-group"><label>A: אורך ארגז/קורה</label><input type="number" id="inp_A" value="400"></div>
            <div class="input-group"><label>B: רוחב בסיס</label><input type="number" id="inp_B" value="350"></div>
            <div class="input-group"><label>C: זרוע הרמה</label><input type="number" id="inp_C" value="180"></div>
            <div class="input-group"><label>D: זרוע מייצבת</label><input type="number" id="inp_D" value="150"></div>
            <div class="input-group"><label>E: מיקום חיבור בוכנה (על C)</label><input type="number" id="inp_E" value="100"></div>
            <div class="input-group"><label>H: מיקום בסיס בוכנה</label><input type="number" id="inp_H" value="120"></div>
            <div class="input-group"><label>F: תמיכה אחורית (מ-P1)</label><input type="number" id="inp_F" value="50"></div>
            <div class="input-group"><label>G: תמיכה קדמית (מ-P4)</label><input type="number" id="inp_G" value="50"></div>
        </div>
    </div>

    <div id="tab-calcs" class="section">
        <div id="mj-loading">מחשב...</div>
        <div id="math-display"></div>
    </div>
</div>

<script>
// --- מנוע פיזיקלי ---
// בחישוב סטטי פשוט בק"ג, אין צורך להכפיל ב-G (9.81) אם התוצאה הרצויה היא בק"ג-כוח
let params = { A:400, B:350, C:180, D:150, E:100, H:120, F:50, G:50, Load:6000, Diam: 10 };

// נקודות גיאומטריות
let P1={x:0,y:0}, P2={x:0,y:0}, P3={x:0,y:0}, P4={x:0,y:0};
let P_piston_base={x:0,y:0}, P_piston_head={x:0,y:0};
let Sup_L={x:0,y:0}, Sup_R={x:0,y:0};

// מצלמה
let cam = { x: 0, y: 0, scale: 1.0 };
let isDragging = false;
let lastTouch = { x:0, y:0, dist:0 };

// השהיית חישוב מתמטיקה
let mathUpdateTimeout;

function solveGeometry(sliderVal) {
    // טווח זווית זרוע C: בין 45 ל-135 מעלות
    const angleC_deg = 45 + (sliderVal/100)*(135-45);
    const radC = angleC_deg * Math.PI / 180;

    P1 = {x: 0, y: 0};
    P4 = {x: params.B, y: 0};
    P_piston_base = {x: params.H, y: 0};
    Sup_L = {x: params.F, y: -20};
    Sup_R = {x: params.B - params.G, y: -20};

    // P2 (קצה עליון של C)
    P2.x = params.C * Math.cos(radC);
    P2.y = params.C * Math.sin(radC);

    // P3 (חיתוך מעגלים למציאת מיקום זרוע D ו-A)
    const d_base = Math.hypot(P4.x - P2.x, P4.y - P2.y);
    if (d_base > params.A + params.D || d_base < Math.abs(params.A - params.D) || d_base <= 1e-5) return null;

    const a = (params.A**2 - params.D**2 + d_base**2) / (2 * d_base);
    const h = Math.sqrt(Math.max(0, params.A**2 - a*a));
    const x2 = P2.x + a * (P4.x - P2.x) / d_base;
    const y2 = P2.y + a * (P4.y - P2.y) / d_base;

    // פתרון "מרפק למעלה"
    P3.x = x2 - h * (P4.y - P2.y) / d_base;
    P3.y = y2 + h * (P4.x - P2.x) / d_base;

    // ראש הבוכנה
    const ratio = params.E / params.C;
    P_piston_head.x = P2.x * ratio;
    P_piston_head.y = P2.y * ratio;

    // זוויות
    const angA = Math.atan2(P3.y - P2.y, P3.x - P2.x);
    const angD = Math.atan2(P3.y - P4.y, P3.x - P4.x);
    const angPiston = Math.atan2(P_piston_head.y - P_piston_base.y, P_piston_head.x - P_piston_base.x);

    return { radC, angA, angD, angPiston };
}

function solveForces(geo) {
    if(!geo) return null;
    const W = params.Load; // ק"ג כוח
    
    // --- שלב 1: שיווי משקל קורה A (מציאת כוח בזרוע D) ---
    // סיכום מומנטים סביב P2 = 0
    // הנחה: עומס מפוזר שקול לכוח מרוכז במרכז הקורה
    const midA = { x: (P2.x+P3.x)/2, y: (P2.y+P3.y)/2 };
    
    // זרוע המומנט של העומס (מרחק אופקי מ-P2)
    const r_load_x = (midA.x - P2.x); // ס"מ
    
    // מומנט עומס (מומנט = כוח * מרחק)
    // המרחק הוא היטל X כי כוח הכבידה פועל ב-Y
    const M_load = r_load_x * W; // kg*cm

    // מומנט מזרוע D. כוח D פועל בנקודה P3.
    const r_D_x = (P3.x - P2.x); // ס"מ
    const r_D_y = (P3.y - P2.y); // ס"מ
    const cosD = Math.cos(geo.angD);
    const sinD = Math.sin(geo.angD);
    
    // מכפלה וקטורית (Cross Product) לחישוב זרוע אפקטיבית
    const lever_D = r_D_x * sinD - r_D_y * cosD;
    
    let F_d = 0;
    if(Math.abs(lever_D) > 1e-4) F_d = -M_load / lever_D; // תוצאה בק"ג

    // --- שלב 2: שיווי משקל זרוע C (מציאת כוח בוכנה) ---
    // ראקציה מ-A ל-C היא הפוכה לכוח ש-C מפעיל על A
    // משיקולי כוחות על A: F_C + F_D + W = 0
    // לכן הכוח ש-A מפעיל על C הוא: F_A_on_C = W + F_D
    
    const F_d_x = F_d * cosD;
    const F_d_y = F_d * sinD;
    const W_y = -W; // כבידה למטה
    
    const Fac_x = F_d_x; 
    const Fac_y = F_d_y + W_y;

    // סיכום מומנטים סביב P1 עבור זרוע C
    // מומנט מהכוח שמגיע מ-A (פועל בנקודה P2)
    const M_from_A = P2.x * Fac_y - P2.y * Fac_x;

    // מומנט מהבוכנה (פועל בנקודה P_head)
    const cosP = Math.cos(geo.angPiston);
    const sinP = Math.sin(geo.angPiston);
    
    // זרוע אפקטיבית של הבוכנה
    const lever_P = P_piston_head.x * sinP - P_piston_head.y * cosP;
    
    let F_p = 0;
    if(Math.abs(lever_P) > 1e-4) F_p = -M_from_A / lever_P;

    // לחץ הידראולי (אם יש קוטר)
    // שטח מעגל = pi * r^2
    const radius = params.Diam / 2;
    const area = Math.PI * radius * radius;
    const pressure = area > 0 ? F_p / area : 0;

    return {
        W, F_d, F_p, pressure,
        M_load, lever_D, 
        Fac_x, Fac_y, M_from_A,
        lever_P,
        cosD, sinD, cosP, sinP,
        r_load_x, r_D_x, r_D_y
    };
}

// --- ציור ---
const canvas = document.getElementById('simCanvas');
const ctx = canvas.getContext('2d');

function initCanvas() {
    const w = canvas.parentElement.clientWidth;
    const h = canvas.parentElement.clientHeight;
    canvas.width = w; canvas.height = h;
    const maxDimX = Math.max(params.B, params.A+params.C); 
    const maxDimY = params.C + params.A/2;
    cam.scale = Math.min(w/(maxDimX*1.2), h/(maxDimY*1.5));
    cam.x = w/2 - (params.B*cam.scale)/2;
    cam.y = h - 80;
}

function draw(geo) {
    const w = canvas.width; const h = canvas.height;
    ctx.clearRect(0, 0, w, h);
    if(!geo) {
        ctx.fillStyle = "red"; ctx.font = "20px Arial"; ctx.textAlign = "center";
        ctx.fillText("שגיאה בגיאומטריה", w/2, h/2); return;
    }

    ctx.save();
    ctx.translate(cam.x, cam.y);
    ctx.scale(cam.scale, -cam.scale);

    const line = (p1, p2, c, lw) => {
        ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y);
        ctx.strokeStyle = c; ctx.lineWidth = lw; ctx.lineCap='round'; ctx.stroke();
    };
    const midpoint = (p1, p2) => ({x:(p1.x+p2.x)/2, y:(p1.y+p2.y)/2});
    const label = (txt, p, ox, oy, c='#333') => {
        ctx.save(); ctx.translate(p.x, p.y); ctx.scale(1, -1);
        ctx.fillStyle=c; ctx.font='bold 16px Arial'; ctx.textAlign='center';
        ctx.fillText(txt, ox, -oy); ctx.restore();
    };

    // קרקע ובסיס
    line({x:-500, y:-20}, {x: 1000, y:-20}, '#ddd', 2);
    line(P1, P4, '#333', 6); label("B", midpoint(P1, P4), 0, -30);

    // תמיכות
    [Sup_L, Sup_R].forEach((p, i) => {
        ctx.fillStyle = '#555'; ctx.beginPath();
        ctx.moveTo(p.x, 0); ctx.lineTo(p.x-15, -20); ctx.lineTo(p.x+15, -20); ctx.fill();
        label(i===0?"F":"G", p, 0, -45);
    });

    // בוכנה
    ctx.lineWidth=params.Diam * cam.scale / 4; // עובי ויזואלי יחסי
    if(ctx.lineWidth < 4) ctx.lineWidth = 4;
    ctx.strokeStyle=getComputedStyle(document.body).getPropertyValue('--accent'); 
    ctx.beginPath(); ctx.moveTo(P_piston_base.x, P_piston_base.y);
    const midP = midpoint(P_piston_base, P_piston_head);
    ctx.lineTo(midP.x, midP.y); ctx.stroke();
    ctx.lineWidth=ctx.lineWidth/2; ctx.strokeStyle='#999';
    ctx.beginPath(); ctx.moveTo(midP.x, midP.y); ctx.lineTo(P_piston_head.x, P_piston_head.y); ctx.stroke();

    // זרועות
    line(P1, P2, '#666', 10); label("C", midpoint(P1, P2), -30, 0);
    line(P4, P3, '#666', 10); label("D", midpoint(P4, P3), 30, 0);
    line(P2, P3, getComputedStyle(document.body).getPropertyValue('--primary'), 14); 
    label("A", midpoint(P2, P3), 0, 30, getComputedStyle(document.body).getPropertyValue('--primary'));

    // חיצי עומס
    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--load-color');
    const arrL = 50/cam.scale; const hS = 12/cam.scale;
    for(let i=1; i<=3; i++) {
        const t = i/4; const px = P2.x + t*(P3.x - P2.x); const py = P2.y + t*(P3.y - P2.y);
        ctx.beginPath(); ctx.moveTo(px, py); ctx.lineTo(px, py - arrL);
        ctx.strokeStyle = ctx.fillStyle; ctx.lineWidth = 4; ctx.stroke();
        ctx.beginPath(); ctx.moveTo(px, py - arrL - hS);
        ctx.lineTo(px - hS/2, py - arrL); ctx.lineTo(px + hS/2, py - arrL); ctx.fill();
    }

    // מפרקים
    [P1, P2, P3, P4, P_piston_base, P_piston_head].forEach(p => {
        ctx.beginPath(); ctx.arc(p.x, p.y, 6, 0, Math.PI*2);
        ctx.fillStyle='#fff'; ctx.fill(); ctx.stroke();
    });

    ctx.restore();
}

// --- עדכון לולאה ---
function updateLoop() {
    ['A','B','C','D','E','H','F','G','Load','Diam'].forEach(k => params[k] = parseFloat(document.getElementById('inp_'+k).value) || 0);
    const sliderVal = parseFloat(document.getElementById('liftSlider').value);
    
    const geo = solveGeometry(sliderVal);
    draw(geo);
    
    if(geo) {
        document.getElementById('angleDisplay').innerText = (geo.radC * 180/Math.PI).toFixed(0) + "°";
        const forces = solveForces(geo);
        
        clearTimeout(mathUpdateTimeout);
        mathUpdateTimeout = setTimeout(() => updateMath(geo, forces), 100);
    }
}

function updateMath(geo, f) {
    if(!document.getElementById('tab-calcs').classList.contains('active')) return;
    
    const loading = document.getElementById('mj-loading');
    loading.classList.add('show');

    // פורמטים למספרים
    const deg = r => (r*180/Math.PI).toFixed(1);
    const N = n => n.toLocaleString('en-US', {maximumFractionDigits: 0}); // שלמים
    const D = n => n.toFixed(2); // 2 עשרוניות

    const tex = `
    <div class="math-text-he">1. גיאומטריה ורכיבים</div>
    $$ \\theta_D = ${deg(geo.angD)}^\\circ \\implies \\cos=${D(f.cosD)}, \\sin=${D(f.sinD)} $$
    $$ \\theta_{Piston} = ${deg(geo.angPiston)}^\\circ \\implies \\cos=${D(f.cosP)}, \\sin=${D(f.sinP)} $$
    
    <div class="math-text-he">2. ניתוח קורה A (מציאת כוח בזרוע D)</div>
    <div class="math-text-he">סיכום מומנטים סביב ציר P2:</div>
    $$ M_{Load} = W \\cdot r_{x} = ${N(f.W)} \\text{kg} \\cdot ${D(f.r_load_x)} \\text{cm} $$
    $$ M_{Load} = ${N(f.M_load)} \\text{ kg}\\cdot\\text{cm} $$
    
    <div class="math-text-he">חישוב הכוח במוט D כדי לאזן את המומנט:</div>
    $$ F_D = \\frac{M_{Load}}{r_{D,x}\\sin(\\theta_D) - r_{D,y}\\cos(\\theta_D)} $$
    $$ F_D = \\frac{${N(f.M_load)}}{(${D(f.r_D_x)} \\cdot ${D(f.sinD)}) - (${D(f.r_D_y)} \\cdot ${D(f.cosD)})} $$
    $$ \\mathbf{F_D = ${N(f.F_d)} \\text{ kg}} $$

    <div class="math-text-he">3. ניתוח זרוע C (מציאת כוח בוכנה)</div>
    <div class="math-text-he">סיכום מומנטים סביב ציר P1. ראשית, הכוחות המגיעים מ-A:</div>
    $$ F_{AC,y} = F_{D,y} - W = (${N(f.F_d)}\\cdot${D(f.sinD)}) - ${N(f.W)} = ${N(f.Fac_y)} $$
    $$ F_{AC,x} = F_{D,x} = ${N(f.F_d)}\\cdot${D(f.cosD)} = ${N(f.Fac_x)} $$
    
    <div class="math-text-he">המומנט שיוצרים כוחות אלו על P1:</div>
    $$ M_{fromA} = P_{2,x} F_{AC,y} - P_{2,y} F_{AC,x} = ${N(f.M_from_A)} \\text{ kg}\\cdot\\text{cm} $$
    
    <div class="math-text-he">כוח הבוכנה הדרוש ($F_p$):</div>
    $$ F_p = \\frac{M_{fromA}}{\\text{LeverArm}_{piston}} $$
    $$ \\mathbf{F_{piston} = ${N(f.F_p)} \\text{ kg}} $$

    <div class="math-text-he">4. לחץ הידראולי נדרש</div>
    <div class="math-text-he">עבור קוטר בוכנה ${params.Diam} ס"מ:</div>
    $$ P = \\frac{F}{Area} = \\frac{${N(f.F_p)}}{\\pi \\cdot (${params.Diam}/2)^2} $$
    $$ \\mathbf{Pressure = ${D(f.pressure)} \\text{ kg}/\\text{cm}^2 \\ (Bar)} $$
    `;

    const el = document.getElementById('math-display');
    el.innerHTML = tex;
    if(window.MathJax) {
        MathJax.typesetPromise([el]).then(() => {
            loading.classList.remove('show');
        });
    }
}

// ג'סטות (מגע)
canvas.addEventListener('touchstart', e => {
    isDragging = true;
    if(e.touches.length === 2) {
        lastTouch.dist = Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY);
    } else { lastTouch.x = e.touches[0].clientX; lastTouch.y = e.touches[0].clientY; }
}, {passive: false});

canvas.addEventListener('touchmove', e => {
    e.preventDefault(); if(!isDragging) return;
    if(e.touches.length === 2) {
        const dist = Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY);
        cam.scale *= (1 + (dist - lastTouch.dist) * 0.005);
        lastTouch.dist = dist;
    } else {
        cam.x += e.touches[0].clientX - lastTouch.x;
        cam.y += e.touches[0].clientY - lastTouch.y;
        lastTouch.x = e.touches[0].clientX; lastTouch.y = e.touches[0].clientY;
    }
    requestAnimationFrame(updateLoop);
}, {passive: false});
canvas.addEventListener('touchend', () => isDragging = false);

// אירועים
document.querySelectorAll('input').forEach(i => i.addEventListener('input', updateLoop));
window.switchTab = function(t, e) {
    document.querySelectorAll('.section, .tab').forEach(d => d.classList.remove('active'));
    document.getElementById('tab-'+t).classList.add('active');
    e.target.classList.add('active');
    if(t === 'calcs') updateLoop();
}

initCanvas();
updateLoop();
</script>
</body>
</html>
